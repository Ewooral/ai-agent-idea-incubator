
// src/ai/flows/generate-novel-idea.ts
'use server';

/**
 * @fileOverview Generates novel ideas or research questions based on user-provided keywords or problem areas.
 *
 * - generateNovelIdea - A function that generates novel ideas.
 * - GenerateNovelIdeaInput - The input type for the generateNovelIdea function.
 * - GenerateNovelIdeaOutput - The return type for the generateNovelIdea function.
 */

import {ai} from '@/ai/genkit';
import {z} from 'genkit';

const GenerateNovelIdeaInputSchema = z.object({
  keywords: z
    .string()
    .describe('Keywords or topics to focus the idea generation on (e.g., "B2B SaaS", "sustainable fashion").')
    .optional(),
  problemArea: z
    .string()
    .describe('A specific problem to generate ideas for (e.g., "reducing food waste", "making oversight scalable").')
    .optional(),
});

export type GenerateNovelIdeaInput = z.infer<typeof GenerateNovelIdeaInputSchema>;

const NovelIdeaSchema = z.object({
  idea: z.string().describe('The novel idea, business concept, or research question text.'),
  noveltyScore: z.number().min(1).max(10).describe('A score from 1 (very common) to 10 (highly novel/unconventional) indicating the AI\'s assessment of the idea\'s originality.'),
});

const GenerateNovelIdeaOutputSchema = z.object({
  novelIdeas: z
    .array(NovelIdeaSchema)
    .describe('A list of novel ideas generated by the AI, each with a novelty score.'),
});

export type GenerateNovelIdeaOutput = z.infer<typeof GenerateNovelIdeaOutputSchema>;

export async function generateNovelIdea(input: GenerateNovelIdeaInput): Promise<GenerateNovelIdeaOutput> {
  return generateNovelIdeaFlow(input);
}

const prompt = ai.definePrompt({
  name: 'generateNovelIdeaPrompt',
  input: {schema: GenerateNovelIdeaInputSchema},
  output: {schema: GenerateNovelIdeaOutputSchema},
  prompt: `You are an expert idea generator, skilled in both business innovation and academic research. Your goal is to generate 3-5 novel and concrete ideas, concepts, or research questions based on the provided input.
  For each idea, provide a "noveltyScore" from 1 (very common) to 10 (highly unique and potentially groundbreaking).
  Avoid vague or overly broad ideas. Focus on concepts that could lead to a concrete project.

  If the input seems research-oriented (e.g., mentions "AI Safety", "interpretability", "alignment"), generate research questions.
  If the input seems business-oriented (e.g., mentions "SaaS", "e-commerce", "sustainability"), generate business concepts.
  If the input is ambiguous, provide a mix.

  {{#if keywords}}User Keywords: {{{keywords}}}{{/if}}
  {{#if problemArea}}User Problem Area: {{{problemArea}}}{{/if}}

  Return the ideas as a list of objects, where each object contains an 'idea' (string, the idea/question) and a 'noveltyScore' (number 1-10).
  Example format for one idea: { "idea": "A subscription box service for discovering artisanal hot sauces from around the world, paired with a Scoville scale education app.", "noveltyScore": 7 }
  `,
});

const generateNovelIdeaFlow = ai.defineFlow(
  {
    name: 'generateNovelIdeaFlow',
    inputSchema: GenerateNovelIdeaInputSchema,
    outputSchema: GenerateNovelIdeaOutputSchema,
  },
  async input => {
    const {output} = await prompt(input);
    if (!output || !Array.isArray(output.novelIdeas)) {
        // Ensure a valid array is returned, even if empty
        return { novelIdeas: [] };
    }
     // Validate and clamp novelty scores
    const validatedIdeas = output.novelIdeas.map(item => ({
      idea: item.idea || "AI failed to provide idea text.",
      noveltyScore: Math.min(10, Math.max(1, Number(item.noveltyScore) || 5)), // Default to 5 if invalid
    }));
    return { novelIdeas: validatedIdeas };
  }
);
